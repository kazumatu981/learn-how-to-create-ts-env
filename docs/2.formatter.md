# 2. フォーマッタを有効にする

## `prettier` をインストールする

```bash
npm install -D prettier
```

## `prettier` を設定する

```text :no-line-numbers
my-project
 + dist
 + node_modules
 + src
 + .prettierignore   // [!code ++]
 + .prettierrc       // [!code ++]
 + package-lock.json
 + package.json
 + tsconfig.json
```

### `.prettierrc`の作成

```json
{
    "printWidth": 80,
    "tabWidth": 4,
    "useTabs": false,
    "semi":true,
    "singleQuote": true,
    "trailingComma": "es5",
    "bracketSpacing": false
}
```

| プロパティ名     | 内容                                                       | デフォルト値 |
| ---------------- | ---------------------------------------------------------- | ------------ |
| `printWidth`     | コードの幅を指定する。                                     | `80`         |
| `tabWidth`       | タブの幅を指定する。                                       | `2`          |
| `useTabs`        | タブでインデントを行うかどうかを指定する。                 | `false`      |
| `semi`           | セミコロンを末尾に追加するかどうかを指定する。             | `true`       |
| `singleQuote`    | シングルクォーテーションで文字列を囲むかどうかを指定する。 | `true`       |
| `trailingComma`  | 文字列の末尾にカンマを追加するかどうかを指定する。         | `es5`        |
| `bracketSpacing` | ブレース内のスペースを追加するかどうかを指定する。         | `true`       |

### `.prettierignore`の作成

```text
dist
node_modules
.prettierrc
.prettierignore
package-lock.json
package.json
```

## 試しに実行してみる

### 未フォーマットなファイルを作成してみる

```text :no-line-numbers
my-project              // [!code focus]
 + ...
 + node_modules
 + src                  // [!code focus]
 |  + unformatted.ts    // [!code focus] // [!code highlight]
 + .prettierignore
 + ...
```

```ts title='src/unformatted.ts'
function someHeavyAction(arg1: string): Promise<number>{
const randNumber = Math.random();
return new Promise(   (resolve)=>{
    console.log('run start:' + arg1)
    setTimeout(()=>{
        console.log("finish:" + arg1)
        resolve(randNumber);
    }, 1000*randNumber);
    })
}
export function runSomeAction(
someArguments: string[])
: Promise<number[]>{
    const resultPromises = someArguments.map(arg =>{
        return someHeavyAction(arg)
    });return Promise.all(resultPromises);
}
```

### フォーマットチェックをする

```bash
npx prettier . --check
```

```bash
Checking formatting...
[warn] bundle.mjs
[warn] src/unformatted.ts
[warn] tsconfig.json
[warn] Code style issues found in 3 files. Run Prettier with --write to fix.
```

### フォーマットの自動修正をする

フォーマットチェックだけではなく、そのまま

```bash
npx prettier src --write
```

それでは、実行結果を見てみましょう。


::: tabs

@tab 修正前

```ts
function someHeavyAction(arg1: string): Promise<number>{
const randNumber = Math.random();
return new Promise(   (resolve)=>{
    console.log('run start:' + arg1)
    setTimeout(()=>{
        console.log("finish:" + arg1)
        resolve(randNumber);
    }, 1000*randNumber);
    })
}
export function runSomeAction(
someArguments: string[])
: Promise<number[]>{
    const resultPromises = someArguments.map(arg =>{
        return someHeavyAction(arg)
    });return Promise.all(resultPromises);
}
```

@tab 修正後

```ts
function someHeavyAction(arg1: string): Promise<number> {
    const randNumber = Math.random();
    return new Promise((resolve) => {
        console.log('run start:' + arg1);
        setTimeout(() => {
            console.log('finish:' + arg1);
            resolve(randNumber);
        }, 1000 * randNumber);
    });
}
export function runSomeAction(someArguments: string[]): Promise<number[]> {
    const resultPromises = someArguments.map((arg) => {
        return someHeavyAction(arg);
    });
    return Promise.all(resultPromises);
}
```

:::

## `npm run` コマンドを使ったフォーマットの実行 <Badge text="オプション" type="tip" vertical="top" />

ルートディレクトリにある `package.json` の `scripts` にフォーマット用のタスクを追加します。

```json title='package.json'
{
    // ...
    "scripts": {
        "format": "npx src --write" // [!code ++]
    }
}
```

上記のように追加しておくと下記の `npm run` コマンドでフォーマットを実行できるようになります。

```bash :no-line-numbers
npm run format
```

## Visual Studio Code の拡張機能を使ったフォーマット実行 <Badge text="オプション" type="tip" vertical="top" />

Visual Studio Codeを使えば、上記の `npm run` による実行より気軽にフォーマットを実行できるように設定できます。
Visual Studio Code には Prettierプロジェクト公式の拡張機能があります。
これをインストールして、設定を行えば、**ファイル保存時に自動でフォーマッタが実行される**ようになります。

### 拡張機能のインストール

下記リンクから Prettier 拡張機能をダウンロードおよびインストールを行ってください。

<VPCard
  title="Prettier - Code formatter"
  link="https://marketplace.visualstudio.com/items?itemName=esbenp.prettier-vscode"
  image="https://esbenp.gallerycdn.vsassets.io/extensions/esbenp/prettier-vscode/11.0.0/1723648421534/Microsoft.VisualStudio.Services.Icons.Default"
  description="Code formatter using prettier"
/>

### 拡張機能の設定

Visual Studio Code の設定は、「ユーザ設定」と「ワークスペース設定」があります。
「ワークスペース設定」をしておくと、以下のようなメリットがあります。

* `.vscode`以下のファイルをプロジェクトメンバと共有することで設定値を共有できる。
* ほかのワークスペースの設定に影響が出ない。

その反面、ワークスペースごとに設定が必要なため、ワークスペース作成時に少し手間がかかります。

今回は、これらのメリットを享受したいので、「ワークスペース設定」とします。

以下のように、 プロジェクトのルートディレクトリに`.vscode`というフォルダとその中に、`setting.json` というファイルを作成してください。

```text :no-line-numbers
my-project              // [!code focus]
 + .vscode// [!code focus]
 |  + setting.json    // [!code focus] // [!code highlight]
 + dist
 + node_modules
 + src
 + ...
```

JSONの中身には、エディタの動作に関する設定をしてください。
「セーブ時にフォーマットを行う」、「フォーマッタにはPrettierを使う」という意味です。

```json
{
    "editor.formatOnSave": true,
    "editor.defaultFormatter": "esbenp.prettier-vscode"
}
```

::: tip
もちろん Visual Studio Code の設定はGUIからも設定できます。
GUIから設定する場合は、上記の設定キー `editor.formatOnSave` と `editor.defaultFormatter` を検索して、設定してください。
:::

::: info
実は、この拡張機能を設定すると、`npm` パッケージの`prettier`のインストールは必要ありません。
Visual Studio Codeを使わないプロジェクトメンバや、自動ビルド用にインストールする手順としました。
:::
