# バンドラ作成環境を構築する

仕上げに、TypeScriptをバンドルしてHTMLからアクセスする手順を示します。
ここで示す手順では `esbuild` を使用します。
バンドラ（bundler） は、複数のJavaScriptファイルやCSS、画像などのWebアセットを、ひとつのファイル（または少数のファイル）にまとめるツールです。

現代のWeb開発では、コードをモジュール化して管理するのが一般的です。
たとえば、機能ごとにファイルを分けたり、外部ライブラリを使ったりします。
しかし、ブラウザはそのままではモジュールを効率よく読み込めないことがあります。
バンドラが果たす役割は以下の通りです。

* ::arrow-down-short-wide /indigo:: 依存関係を解析して、必要な順序でコードをまとめる
* ::scissors /indigo:: 不要なコードを除去（Tree Shaking）
* ::arrows-down-to-line /indigo:: 圧縮・最適化して読み込みを高速化

長年 `webpack` というパッケージが一般的ですが、近年 `esbuild` が洗練されており高速に動作することから、急速に人気を集め始めました。

それでは、早速プロジェクトにインストールです。
いつものように、`npm install` コマンドでインストールします。

```bash :no-line-numbers
npm install -D esbuild
```

## ビルドスクリプトの作成

`esbuild` はCLIを持っていますが、今回は後々のことも考えて、独自に **バンドルスクリプト** を記述して、実行する方式を紹介します。

### 構成

**バンドルスクリプト** は特に決まりがありませんが、以下の考え方からディレクトリ構造を検討します。

* ソースコードとバンドルスクリプトが混同しないようにする
* ほかのツールと同様設定ファイルをルートディレクトリに配置する。

```text :no-line-numbers
my-project
 + .vscode
 + bin                  // [!code ++]
 |  + bundle.mjs        // [!code ++]
 + dist
 + node_modules
 + src
 + ...
 + esbuild.config.mjs  // [!code ++]
 + ...
 + package.json
 + tsconfig.json
```

ルートディレクトリに `bin` というフォルダを作成して、そこにバンドルスクリプト(`bundle.mjs`)を配置します。
`esbuild.config.mjs` にはこのプロジェクトのビルドオプションを記述します。

### バンドルスクリプト本体: `bundle.mjs`

バンドルスクリプトは以下のように記述します。

```javascript title="bin/bundle.mjs"
import * as esbuild from 'esbuild';
import {releaseConfig, developConfig} from '../esbuild.config.mjs';

const mode = process.argv[2];
console.log(`bundle TypeScript sources: ${mode} mode`);

// 設定を読み取る
const config = mode === 'release' ? releaseConfig : developConfig;

// ビルドを実行する
await esbuild.build(config);
```

* バンドル本体は `await esbuild.build(config)` で行う
* コマンド引数で `release` モードと `develop` モードの二つのモードを準備する
* バンドルの設定は `esbuild.config.mjs` にJSONオブジェクトとして定義しておく

### バンドル設定ファイル: `esbuild.config.mjs`

設定ファイルには、ビルド設定を記述します。

```javascript title="esbuild.config.mjs"
// 共通設定
const commonConfig = {
    entryPoints: ['src/home.ts'],   // バンドルしたいライブラリのエントリポイント
    outbase: 'src',
    entryNames: '[dir]/[name]-bundle',
    bundle: true,                   // バンドルする
    logLevel: 'info',
};

// release モード時の設定
export const releaseConfig = {
    ...commonConfig,
    ...{
        minify: true,                   // ソース圧縮あり
        outdir: 'dist/bundle/release',
    },
};

// develop モード時の設定
export const developConfig = {
    ...commonConfig,
    ...{
        minify: false,                  // ソース圧縮なし
        sourcemap: 'inline',            // ソースマップをバンドル内に
        outdir: 'dist/bundle/develop',
    },
};
```

設定は以下を意味します。

* 共通設定
  * エントリポイント(入口)の設定 HTMLから読み込みたいスクリプト
  * 出力ファイル名は、`<名前>-bundle.js` 形式とする
  * `import`/`export`を解決してバンドルとする
  * バンドル中はコンソールにログを出力する
* release設定
  * **圧縮する**
  * `dist/bundle/release`に出力する
* develop設定
  * 圧縮はしない
  * ソースマップをコメントとして出力する(Chromeの開発者モードでデバックをTypeScriptで実行できる)
  * `dist/bundle/develop`に出力する

そのほかにも多くの設定があります。
詳細は
[こちら](https://esbuild.github.io/api/#overview)
をご参照ください。

## 試しに実行してみる

### テスト用コードの追加

```text :no-line-numbers
my-project
 + ...
 + dist
 + node_modules
 + src
 |  + hello.ts  // [!code ++]
 |  + home.ts   // [!code ++]
 + ....
```

```javascript title="src/hello.ts"
export function sayHello(id: string, name: string): void {
    const helloDom = document.getElementById(id) as HTMLDivElement | null;
    if (helloDom) {
        helloDom.textContent = `こんにちは ${name} さん`;
    } else {
        console.error('要素が見つかりません');
    }
}
```

```javascript title="src/home.ts"
import {sayHello} from './hello';

document.addEventListener('DOMContentLoaded', () => {
    const button = document.getElementById(
        'myButton'
    ) as HTMLButtonElement | null;
    const textInput = document.getElementById(
        'myInput'
    ) as HTMLInputElement | null;

    if (button && textInput) {
        button.addEventListener('click', () => {
            const yourName = textInput.value;
            sayHello('greetingArea', yourName);
        });
    }
});
```

### ビルドの実行

```bash :no-line-numbers
node bin/bundle.mjs develop
```

### 結果の確認

```text :no-line-numbers
my-project
 + ...
 + dist/bundle/develop
 +  + home-bundle.js
 + src
 |  + hello.ts  // [!code ++]
 |  + home.ts   // [!code ++]
 + ....
```

## スクリプトの登録

```json title="package.json"
{
    "name": "my-project",
    "version": "1.0.0",
    // ...
    "scripts": {
        // ...
        "build:develop": "node bin/bundle.mjs develop",
        "build:release": "node bin/bundle.mjs release",
        "build:clean": "npx rimraf dist"
        // ...
    }
}
```

::: warning
ここで、`typescript` のビルド成果を使わないことに注目してください。
つまり、`esbuild` は`typescript`を独自にビルドしています。
ここで「ビルド」と記述しましたが、`esbuild` では、型チェックは行いません。
型チェックは必ず
[TypeScriptトランスパイル環境を作成する](./1.init-typescript.md)
で準備した `npm run build:check` を使うようにしてください。
:::


## さいごに

### ページを作って試しに動作させてみよう

```text :no-line-numbers
my-project
 + ...
 + dist/bundle/develop
 +  + home-bundle.js
 + src
 + pages               // [!code ++]
 |  + home.html     // [!code ++]
 + ....
```

```html title="pages/home.html"
<!doctype html>
<html>
    <head> </head>
    <body>
        <input type="text" id="myInput" />
        <button id="myButton">click me</button>
        <div id="greetingArea"></div>
        <script src="../dist/bundle/develop/home-bundle.js"></script>
    </body>
</html>
```

### VS Codeで小さいWebサーバを起動する <Badge text="オプション" type="tip" vertical="top" />

<VPCard
  title="Live Preview"
  link="https://marketplace.visualstudio.com/items?itemName=ms-vscode.live-server"
  image="https://ms-vscode.gallerycdn.vsassets.io/extensions/ms-vscode/live-server/0.5.2025063001/1751275524005/Microsoft.VisualStudio.Services.Icons.Default"
  description=
    "Hosts a local server in your workspace for you to preview your webpages on."
/>

### ページが増える場合

```javascript title="esbuild.config.mjs"

// 共通設定
const commonConfig = {
    entryPoints: [
        'src/home.ts',
        'src/login.ts',   // [!code ++]
        'src/user.ts',    // [!code ++]
        ],
    outbase: 'src',
    entryNames: '[dir]/[name]-bundle',
    bundle: true,                   // バンドルする
    logLevel: 'info',
};

// ....
```

