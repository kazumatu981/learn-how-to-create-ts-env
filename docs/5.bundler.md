# ::cubes::バンドラ作成環境を構築する

```bash :no-line-numbers
npm install -D esbuild
```

## ビルドスクリプトの作成

### 構成

```text :no-line-numbers
my-project
 + .vscode
 + bin                  // [!code ++]
 |  + bundle.mjs        // [!code ++]
 + dist
 + node_modules
 + src
 + ...
 + esbuild.config.mjs  // [!code ++]
 + ...
 + package.json
 + tsconfig.json
```

### バンドルスクリプト本体: `bundle.mjs`

```javascript title="bin/bundle.mjs"
import * as esbuild from 'esbuild';
import {releaseConfig, developConfig} from '../esbuild.config.mjs';

const mode = process.argv[2];
console.log(`bundle TypeScript sources: ${mode} mode`);

// 設定を読み取る
const config = mode === 'release' ? releaseConfig : developConfig;

// ビルドを実行する
await esbuild.build(config);
```

### バンドル設定ファイル: `esbuild.config.mjs`

```javascript title="esbuild.config.mjs"

// 共通設定
const commonConfig = {
    entryPoints: ['src/home.ts'],   // バンドルしたいライブラリのエントリポイント
    outbase: 'src',
    entryNames: '[dir]/[name]-bundle',
    bundle: true,                   // バンドルする
    logLevel: 'info',
};

// release モード時の設定
export const releaseConfig = {
    ...commonConfig,
    ...{
        minify: true,                   // ソース圧縮あり
        outdir: 'dist/bundle/release',
    },
};

// develop モード時の設定
export const developConfig = {
    ...commonConfig,
    ...{
        minify: false,                  // ソース圧縮なし
        sourcemap: 'inline',            // ソースマップをバンドル内に
        outdir: 'dist/bundle/develop',
    },
};
```

## クリーン用パッケージのインストール <Badge text="オプション" type="tip" vertical="top" />

```bash :no-line-numbers
npm install -D rimraf
```

## 試しに実行してみる

### テスト用コードの追加

```text :no-line-numbers
my-project
 + ...
 + dist
 + node_modules
 + src
 |  + hello.ts  // [!code ++]
 |  + home.ts   // [!code ++]
 + ....
```

```javascript title="src/hello.ts"
export function sayHello(id: string, name: string): void {
    const helloDom = document.getElementById(id) as HTMLDivElement | null;
    if (helloDom) {
        helloDom.textContent = `こんにちは ${name} さん`;
    } else {
        console.error('要素が見つかりません');
    }
}
```

```javascript title="src/home.ts"
import {sayHello} from './hello';

document.addEventListener('DOMContentLoaded', () => {
    const button = document.getElementById(
        'myButton'
    ) as HTMLButtonElement | null;
    const textInput = document.getElementById(
        'myInput'
    ) as HTMLInputElement | null;

    if (button && textInput) {
        button.addEventListener('click', () => {
            const yourName = textInput.value;
            sayHello('greetingArea', yourName);
        });
    }
});
```

### ビルドの実行

```bash :no-line-numbers
node bin/bundle.mjs develop
```

### 結果の確認

```text :no-line-numbers
my-project
 + ...
 + dist/bundle/develop
 +  + home-bundle.js
 + src
 |  + hello.ts  // [!code ++]
 |  + home.ts   // [!code ++]
 + ....
```

## スクリプトの登録

```json title="package.json"
{
    "name": "my-project",
    "version": "1.0.0",
    // ...
    "scripts": {
        // ...
        "build:develop": "node bin/bundle.mjs develop",
        "build:release": "node bin/bundle.mjs release",
        "build:clean": "npx rimraf dist"
        // ...
    }
}
```

## さいごに

### ページを作って試しに動作させてみよう

```text :no-line-numbers
my-project
 + ...
 + dist/bundle/develop
 +  + home-bundle.js
 + src
 + pages               // [!code ++]
 |  + home.html     // [!code ++]
 + ....
```

```html title="pages/home.html"
<!doctype html>
<html>
    <head> </head>
    <body>
        <input type="text" id="myInput" />
        <button id="myButton">click me</button>
        <div id="greetingArea"></div>
        <script src="../dist/bundle/develop/home-bundle.js"></script>
    </body>
</html>
```

### VS Codeで小さいWebサーバを起動する <Badge text="オプション" type="tip" vertical="top" />

<VPCard
  title="Live Preview"
  link="https://marketplace.visualstudio.com/items?itemName=ms-vscode.live-server"
  image="https://ms-vscode.gallerycdn.vsassets.io/extensions/ms-vscode/live-server/0.5.2025063001/1751275524005/Microsoft.VisualStudio.Services.Icons.Default"
  description="Hosts a local server in your workspace for you to preview your webpages on."
/>


### ページが増える場合

```javascript title="esbuild.config.mjs"

// 共通設定
const commonConfig = {
    entryPoints: [
        'src/home.ts',
        'src/login.ts',   // [!code ++]
        'src/user.ts',    // [!code ++]
        ],
    outbase: 'src',
    entryNames: '[dir]/[name]-bundle',
    bundle: true,                   // バンドルする
    logLevel: 'info',
};

// ....
```
